<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ä¾¿ç•¶å«è™Ÿç³»çµ±ï¼ˆèªéŸ³+å–æ¶ˆ+å¯†ç¢¼é‡ç½®ï¼Œè™Ÿç¢¼001~100ï¼‰</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 2em;
      background-color: #f9f9f9;
      min-height: 100vh;
      margin: 0;
      position: relative;
    }
    .menu-container {
      display: flex;
      justify-content: center;
      gap: 3em;
      margin-bottom: 2em;
    }
    .menu-item {
      border: 2px solid #ccc;
      padding: 1.5em;
      border-radius: 15px;
      width: 200px;
      background-color: #fff;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
    }
    .menu-item button {
      font-size: 1.5em;
      padding: 0.5em 1em;
      border-radius: 10px;
      cursor: pointer;
    }
    .counter {
      margin-top: 0.8em;
      font-size: 1.2em;
      color: #555;
    }
    #ticket {
      margin-top: 2em;
      font-size: 2em;
      min-height: 1.8em;
    }
    #qrcode {
      margin-top: 1em;
    }
    #qrcode img {
      width: 200px;
      margin-top: 10px;
      cursor: pointer;
    }
    .callout {
      margin-top: 2em;
      font-size: 1.5em;
      color: #2c3e50;
      min-height: 2em;
    }
    #cancelBtn {
      margin-top: 1.5em;
      padding: 0.5em 1.2em;
      font-size: 1.2em;
      border-radius: 8px;
      background-color: #f39c12;
      color: white;
      border: none;
      cursor: pointer;
      display: none; /* é è¨­éš±è— */
    }
    #resetBtn {
      position: fixed;
      right: 15px;
      bottom: 15px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 1.5em;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #passwordPrompt {
      position: fixed;
      bottom: 70px;
      right: 15px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      display: none;
      width: 220px;
      text-align: left;
    }
    #passwordPrompt input[type="password"] {
      width: calc(100% - 20px);
      padding: 6px 10px;
      margin-bottom: 8px;
      font-size: 1em;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    #passwordPrompt button {
      padding: 6px 12px;
      font-size: 1em;
      border-radius: 6px;
      border: none;
      background-color: #27ae60;
      color: white;
      cursor: pointer;
    }
    #passwordError {
      color: red;
      font-size: 0.9em;
      margin-top: 4px;
      min-height: 1.2em;
    }
  </style>
</head>
<body>
  <h1>ğŸ± ä¾¿ç•¶å«è™Ÿç³»çµ±</h1>
  <p>è«‹é¸æ“‡æ‚¨çš„ä¾¿ç•¶å“é …ï¼ˆé™è™Ÿç¢¼ 001 ~ 100ï¼‰</p>

  <div class="menu-container">
    <div class="menu-item">
      <button onclick="getTicket('é›è…¿')">ğŸ— é›è…¿ä¾¿ç•¶</button>
      <div class="counter" id="count-é›è…¿">ç›®å‰è™Ÿç¢¼ï¼š000</div>
    </div>
    <div class="menu-item">
      <button onclick="getTicket('æ’éª¨')">ğŸ¥© æ’éª¨ä¾¿ç•¶</button>
      <div class="counter" id="count-æ’éª¨">ç›®å‰è™Ÿç¢¼ï¼š000</div>
    </div>
  </div>

  <div id="ticket"></div>
  <div id="qrcode"></div>
  <div class="callout" id="callout"></div>

  <button id="cancelBtn" onclick="cancelLastTicket()">å–æ¶ˆæœ¬æ¬¡è™Ÿç¢¼</button>

  <!-- é•·æŒ‰3ç§’å‡ºç¾é‡ç½®å¯†ç¢¼è¼¸å…¥ -->
  <button id="resetBtn" title="é•·æŒ‰ 3 ç§’é‡ç½®è™Ÿç¢¼">ğŸ”„</button>

  <div id="passwordPrompt">
    <label for="resetPassword">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼é‡ç½®è™Ÿç¢¼ï¼š</label><br/>
    <input type="password" id="resetPassword" autocomplete="off" />
    <button onclick="checkPassword()">ç¢ºå®š</button>
    <div id="passwordError"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script>
    const counters = {
      'é›è…¿': parseInt(localStorage.getItem('é›è…¿')) || 0,
      'æ’éª¨': parseInt(localStorage.getItem('æ’éª¨')) || 0
    };

    let lastTicket = null;
    let cancelTimeout = null;

    function updateCounts() {
      document.getElementById('count-é›è…¿').textContent = `ç›®å‰è™Ÿç¢¼ï¼š${String(counters['é›è…¿']).padStart(3,'0')}`;
      document.getElementById('count-æ’éª¨').textContent = `ç›®å‰è™Ÿç¢¼ï¼š${String(counters['æ’éª¨']).padStart(3,'0')}`;
    }

    function speak(text) {
      if (!window.speechSynthesis) return;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'zh-TW';
      speechSynthesis.cancel();
      speechSynthesis.speak(utterance);
    }

    function getTicket(type) {
      if (counters[type] >= 100) {
        alert(`${type}ä¾¿ç•¶å·²ç™¼å®Œï¼ˆ001 ~ 100 è™Ÿï¼‰`);
        return;
      }

      counters[type]++;
      const number = counters[type];

      localStorage.setItem(type, counters[type]);

      const numberStr = String(number).padStart(3,'0');
      const ticketText = `${type}ä¾¿ç•¶ #${numberStr}`;

      document.getElementById('ticket').textContent = `æ‚¨çš„è™Ÿç¢¼ç‰Œæ˜¯ï¼š${ticketText}`;
      document.getElementById('qrcode').innerHTML = '';
      QRCode.toCanvas(document.createElement('canvas'), ticketText, function(err, canvas) {
        if (err) {
          console.error(err);
          return;
        }
        const img = document.createElement('img');
        img.src = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = img.src;
        link.download = `${ticketText}.png`;
        link.appendChild(img);
        link.title = 'é»æˆ‘ä¸‹è¼‰ QR Code åœ–ç‰‡';
        document.getElementById('qrcode').appendChild(link);
      });

      updateCounts();

      // æ”¹æˆé–‹é ­åŠ ã€Œè«‹æ³¨æ„ã€
      const callText = `æ‚¨çš„ ${type}ä¾¿ç•¶ï¼Œ${numberStr}è™Ÿï¼Œè«‹ä¸‹è¼‰äºŒç¶­ç¢¼ï¼Œä»¥ä¾¿é ˜é¤ï¼`;
      document.getElementById('callout').textContent = callText;
      speak(callText);

      lastTicket = {type, number};
      document.getElementById('cancelBtn').style.display = 'inline-block';

      if(cancelTimeout) clearTimeout(cancelTimeout);
      cancelTimeout = setTimeout(() => {
        lastTicket = null;
        document.getElementById('cancelBtn').style.display = 'none';
      }, 10000);
    }

    function cancelLastTicket() {
      if(!lastTicket) return;
      if(!confirm(`ç¢ºå®šè¦å–æ¶ˆ ${lastTicket.type}ä¾¿ç•¶ #${String(lastTicket.number).padStart(3,'0')} å—ï¼Ÿ`)) return;

      counters[lastTicket.type] = lastTicket.number - 1;
      localStorage.setItem(lastTicket.type, counters[lastTicket.type]);
      updateCounts();

      document.getElementById('ticket').textContent = '';
      document.getElementById('qrcode').innerHTML = '';
      document.getElementById('callout').textContent = '';
      speechSynthesis.cancel();

      lastTicket = null;
      document.getElementById('cancelBtn').style.display = 'none';

      alert('å·²æˆåŠŸå–æ¶ˆä¸Šæ¬¡è™Ÿç¢¼');
    }

    const resetBtn = document.getElementById('resetBtn');
    const passwordPrompt = document.getElementById('passwordPrompt');
    const passwordInput = document.getElementById('resetPassword');
    const passwordError = document.getElementById('passwordError');
    let pressTimer = null;

    resetBtn.addEventListener('mousedown', () => {
      pressTimer = setTimeout(() => {
        passwordPrompt.style.display = 'block';
        passwordInput.focus();
      }, 3000);
    });
    resetBtn.addEventListener('mouseup', () => clearTimeout(pressTimer));
    resetBtn.addEventListener('mouseleave', () => clearTimeout(pressTimer));

    function checkPassword() {
      const pwd = passwordInput.value;
      const correctPassword = '1234';

      if(pwd === correctPassword) {
        if(confirm('å¯†ç¢¼æ­£ç¢ºï¼Œç¢ºå®šè¦é‡ç½®è™Ÿç¢¼ï¼Ÿ')) {
          localStorage.removeItem('é›è…¿');
          localStorage.removeItem('æ’éª¨');
          counters['é›è…¿'] = 0;
          counters['æ’éª¨'] = 0;
          updateCounts();
          document.getElementById('ticket').textContent = '';
          document.getElementById('qrcode').innerHTML = '';
          document.getElementById('callout').textContent = '';
          lastTicket = null;
          document.getElementById('cancelBtn').style.display = 'none';
          alert('è™Ÿç¢¼å·²é‡ç½®ç‚º 000');
          passwordPrompt.style.display = 'none';
          passwordInput.value = '';
          passwordError.textContent = '';
        }
      } else {
        passwordError.textContent = 'å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥';
        passwordInput.value = '';
        passwordInput.focus();
      }
    }

    updateCounts();
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>客戶消費週期預測系統</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 20px;
  background: #f5f5f5;
}
.container {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  max-width: 900px;
  margin: auto;
}
label { display: block; margin-top: 10px; font-weight: bold; }
input[type="text"], input[type="date"] {
  padding: 5px;
  margin-top: 5px;
  border: 1px solid #ccc;
  border-radius: 4px;
}
input[type="date"] {
  width: 140px; /* 適中寬度 */
}
button {
  margin-top: 10px;
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
#mainBtn { background: #4CAF50; color: white; }
#exportCSV, #exportJSON { background: #2196F3; color: white; }
.action-btn { padding: 4px 8px; margin: 0 2px; }
.edit { background: #FFC107; }
.remove-date { background: #e74c3c; color: white; margin-left: 5px; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
table, th, td { border: 1px solid #ccc; }
th, td { padding: 8px; text-align: center; }
.status-normal { background: #d4edda; }
.status-warning { background: #fff3cd; }
.status-danger { background: #f8d7da; }
.chart-container { margin-top: 20px; background: white; padding: 10px; border-radius: 8px; display: none; }
.date-row { margin-bottom: 5px; }
</style>
</head>
<body>
<div class="container">
<h2>客戶消費週期預測系統</h2>
<label>客戶名稱：</label>
<input type="text" id="customerName" placeholder="輸入客戶名稱">

<div id="datesContainer">
  <label>消費日期紀錄：</label>
  <div class="date-row">
    <input type="date" onchange="autoCalc()">
    <button class="remove-date" onclick="removeDate(this)">刪除</button>
  </div>
</div>
<button onclick="addDate()">+ 新增日期</button><br>

<button id="mainBtn" onclick="saveRecord()">新增客戶</button>
<button id="exportCSV" onclick="exportCSV()">匯出 CSV</button>
<button id="exportJSON" onclick="exportJSON()">匯出 JSON</button>

<table id="dataTable">
  <thead>
    <tr>
      <th>客戶</th>
      <th>平均週期</th>
      <th>最近消費日</th>
      <th>下次消費日</th>
      <th>波動率</th>
      <th>狀態</th>
      <th>紀錄數</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="chart-container">
  <h3 id="chartTitle"></h3>
  <canvas id="cycleChart"></canvas>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let records = JSON.parse(localStorage.getItem("crmRecordsHistory") || "[]");
let editIndex = null;
let chartInstance = null;

function saveToLocal(){
  localStorage.setItem("crmRecordsHistory", JSON.stringify(records));
}
function parseDate(v){ return v ? new Date(v + 'T00:00:00') : null; }
function daysBetween(a,b){ return Math.round((b-a)/(1000*60*60*24)); }
function addDays(d,days){ let nd=new Date(d); nd.setDate(nd.getDate()+days); return nd; }
function fmtDate(d){ return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0')+"-"+String(d.getDate()).padStart(2,'0'); }
function stddev(arr){
  if(arr.length < 2) return 0;
  const avg = arr.reduce((a,b)=>a+b,0)/arr.length;
  return Math.sqrt(arr.reduce((a,b)=>a+Math.pow(b-avg,2),0)/arr.length).toFixed(1);
}

function addDate(value=""){
  const row = document.createElement("div");
  row.className = "date-row";
  row.innerHTML = `<input type="date" value="${value}" onchange="autoCalc()">
                   <button class="remove-date" onclick="removeDate(this)">刪除</button>`;
  document.getElementById("datesContainer").appendChild(row);
}

function removeDate(btn){
  btn.parentElement.remove();
  autoCalc();
}

function getDatesFromInputs(){
  let inputs = document.querySelectorAll("#datesContainer input[type='date']");
  let dates = [];
  inputs.forEach(i => { if (i.value) dates.push(i.value); });
  dates.sort((a,b) => new Date(b) - new Date(a));
  return dates;
}

function autoCalc(){
  const name = document.getElementById("customerName").value.trim();
  if (!name) return;
  const dates = getDatesFromInputs();
  if (dates.length < 2) return;

  let intervals = [];
  for (let i=0; i<dates.length-1; i++){
    intervals.push(daysBetween(parseDate(dates[i+1]), parseDate(dates[i])));
  }
  const avg = Math.round(intervals.reduce((a,b)=>a+b,0) / intervals.length);
  const nextDate = fmtDate(addDays(parseDate(dates[0]), avg));
  const deviation = stddev(intervals);

  const daysSinceLast = daysBetween(parseDate(dates[0]), new Date());
  let status = "正常", statusClass = "status-normal";
  if (daysSinceLast > avg * 1.5){
    status = "⚠ 流失風險"; statusClass = "status-danger";
  } else if (daysSinceLast >= avg * 0.9){
    status = "⏳ 即將到期"; statusClass = "status-warning";
  }

  let idx = editIndex !== null ? editIndex : records.findIndex(r => r.customer === name);
  if (idx !== -1) {
    records[idx] = { customer: name, cycle: avg, lastDate: dates[0], nextDate, deviation, status, statusClass, dates };
  } else {
    records.push({ customer: name, cycle: avg, lastDate: dates[0], nextDate, deviation, status, statusClass, dates });
    idx = records.length - 1;
  }
  saveToLocal();
  renderTable();
  showChart(name, intervals);
}

function saveRecord(){ clearInputs(); }

function renderTable(){
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";
  records.forEach((r,i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.customer}</td>
      <td>${r.cycle}</td>
      <td>${r.lastDate}</td>
      <td>${r.nextDate}</td>
      <td>${r.deviation}</td>
      <td class="${r.statusClass}">${r.status}</td>
      <td>${r.dates.length}</td>
      <td>
        <button class="action-btn edit" onclick="editRecord(${i})">修改</button>
        <button class="action-btn" onclick="deleteRecord(${i})">刪除</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function editRecord(i){
  const r = records[i];
  document.getElementById("customerName").value = r.customer;
  const container = document.getElementById("datesContainer");
  container.innerHTML = '<label>消費日期紀錄：</label>';
  r.dates.forEach(d => addDate(d));
  editIndex = i;
  document.getElementById("mainBtn").textContent = "更新客戶";
  autoCalc();
}

function deleteRecord(i){
  if (confirm("確定刪除？")){
    records.splice(i,1);
    saveToLocal();
    renderTable();
    document.querySelector(".chart-container").style.display = "none";
  }
}

function clearInputs(){
  document.getElementById("customerName").value = "";
  const container = document.getElementById("datesContainer");
  container.innerHTML = '<label>消費日期紀錄：</label>';
  addDate();
  editIndex = null;
  document.getElementById("mainBtn").textContent = "新增客戶";
  document.querySelector(".chart-container").style.display = "none";
}

function exportCSV(){
  let csv = "客戶,平均週期,最近消費日,下次消費日,波動率,狀態,紀錄數\n";
  records.forEach(r => {
    csv += `${r.customer},${r.cycle},${r.lastDate},${r.nextDate},${r.deviation},${r.status},${r.dates.length}\n`;
  });
  downloadFile("records.csv", "\uFEFF" + csv);
}

function exportJSON(){
  const json = JSON.stringify(records, null, 2);
  downloadFile("records.json", json);
}

function downloadFile(filename, content){
  const blob = new Blob([content], {type: "text/plain;charset=utf-8"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
}

function showChart(name, intervals){
  document.querySelector(".chart-container").style.display = "block";
  document.getElementById("chartTitle").textContent = `${name} - 全歷史間隔趨勢`;
  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(document.getElementById("cycleChart"), {
    type: 'line',
    data: {
      labels: intervals.map((_,i)=>`間隔 ${i+1}`),
      datasets: [{
        label: '間隔天數',
        data: intervals,
        borderColor: '#4CAF50',
        fill: false,
        tension: 0.2,
        pointRadius: 5,
        pointBackgroundColor: '#4CAF50'
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true } }
    }
  });
}

renderTable();
</script>
</body>
</html>